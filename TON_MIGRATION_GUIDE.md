# TON Integration Migration Guide

## Обзор изменений

Бот был полностью переработан для работы с TON (The Open Network) криптовалютой вместо Telegram Stars и YooKassa (RUB). Это обеспечивает:

✅ **Полную автоматизацию платежей** - нет необходимости в ручном подтверждении админом
✅ **Мгновенные выплаты** - призы отправляются автоматически в течение секунд
✅ **Минимальные комиссии** - ~0.01 TON вместо 15-20%
✅ **Полная прозрачность** - все транзакции в блокчейне
✅ **Лучший UX** - автоматическая обработка без задержек

## Изменения в архитектуре

### 1. База данных

**Новые поля в таблице `users`:**
- `balance_ton` (Float) - баланс пользователя в TON
- `ton_wallet_address` (String) - TON кошелек пользователя для получения призов

**Новые поля в таблице `transactions`:**
- `transaction_hash` (String, indexed) - хеш транзакции в TON blockchain для верификации

**Новые поля в таблице `withdrawal_requests`:**
- `wallet_address` (String) - TON адрес для вывода средств

**Обновлен enum `CurrencyType`:**
- Добавлено значение `TON`

### 2. Конфигурация

**Новые переменные окружения (.env):**
```bash
# TON Configuration
TON_CENTER_API_KEY=your_api_key_here          # API ключ TON Center
TON_WALLET_ADDRESS=UQxx...                    # Адрес кошелька бота
TON_WALLET_MNEMONIC=word1 word2 ... word24    # Мнемоник кошелька (24 слова)
TON_NETWORK=mainnet                            # mainnet или testnet

# TON Settings
TON_ENTRY_FEE=0.5                             # Взнос в TON
TON_COMMISSION_PERCENT=12                      # Комиссия бота (12%)
TON_RESERVE_MIN=10.0                          # Минимальный резерв
TON_RESERVE_TARGET=20.0                       # Целевой резерв
MIN_WITHDRAWAL_TON=0.1                        # Минимальная сумма вывода
TON_ONLY=true                                 # Использовать ТОЛЬКО TON
TON_TRANSACTION_CHECK_INTERVAL=15             # Интервал проверки транзакций (сек)
TON_TRANSACTION_CONFIRMATIONS=1               # Количество подтверждений
```

### 3. Новые сервисы

#### `app/services/ton_service.py`
Основной сервис для работы с TON blockchain:
- `get_balance()` - получение баланса кошелька бота
- `check_incoming_transactions()` - мониторинг входящих транзакций
- `send_ton()` - отправка TON на адрес
- `send_prize_payout()` - отправка приза победителю
- `verify_transaction()` - верификация транзакции
- `generate_payment_comment()` - генерация уникального комментария для платежа
- `parse_payment_comment()` - парсинг комментария платежа

#### `app/services/ton_monitor.py`
Фоновый сервис для мониторинга транзакций:
- Запускается автоматически при старте бота
- Проверяет новые транзакции каждые 15 секунд (настраивается)
- Автоматически регистрирует участников после оплаты
- Запускает розыгрыш при достижении минимального количества участников

### 4. Обновленные компоненты

**app/handlers/payment.py:**
- Добавлен `callback_pay_ton()` - обработчик TON платежей
- Показывает инструкции по оплате с адресом кошелька и уникальным комментарием

**app/handlers/raffle.py:**
- Добавлена `handle_ton_payout()` - автоматическая выплата призов через TON
- Обновлена `execute_raffle()` - поддержка TON валюты
- Проверка наличия TON кошелька у победителя

**app/handlers/start.py:**
- Обновлено отображение баланса для TON
- Добавлена информация о TON кошельке
- Обновлены правила с информацией о TON платежах

**app/keyboards/inline.py:**
- Обновлена `payment_choice()` - отображает кнопку "Оплатить TON"
- Добавлена кнопка "Указать TON кошелек" в balance_keyboard

**app/main.py:**
- Запуск TON мониторинга при старте бота
- Проверка баланса кошелька при старте
- Уведомление админа о балансе
- Корректное закрытие TON сервисов при остановке

### 5. Зависимости

**Добавлены новые библиотеки в requirements.txt:**
```
pytoniq>=0.1.38
pytoniq-core>=0.1.30
tonsdk
```

## Инструкция по миграции

### Шаг 1: Установка зависимостей

```bash
pip install -r requirements.txt
```

### Шаг 2: Создание TON кошелька

1. Установите Tonkeeper или другой TON кошелек
2. Создайте новый кошелек
3. Сохраните 24-словную мнемоническую фразу (seed phrase)
4. Скопируйте адрес кошелька (формат: UQxx...)
5. **ВАЖНО:** Пополните кошелек минимум на 20 TON для резерва

### Шаг 3: Получение TON Center API ключа

1. Перейдите на https://toncenter.com
2. Зарегистрируйтесь или войдите
3. Получите API ключ
4. Для mainnet используйте основной API
5. Для testnet используйте testnet API

### Шаг 4: Настройка .env файла

```bash
cp .env.example .env
nano .env
```

Заполните TON параметры:
```env
TON_CENTER_API_KEY=your_api_key_here
TON_WALLET_ADDRESS=UQxxxxxxxxx...
TON_WALLET_MNEMONIC=word1 word2 word3 ... word24
TON_NETWORK=mainnet
TON_ONLY=true
```

### Шаг 5: Применение миграции базы данных

```bash
# Проверить текущую версию БД
alembic current

# Применить миграцию
alembic upgrade head

# Проверить что миграция применилась
alembic current
```

**ВАЖНО:** Миграция добавляет новые поля, но НЕ удаляет старые (balance_stars, balance_rub). Это сделано для возможности отката.

### Шаг 6: Тестирование

#### Testnet (рекомендуется для начала)

1. Установите `TON_NETWORK=testnet` в .env
2. Используйте testnet кошелек
3. Получите testnet TON из faucet
4. Протестируйте полный цикл:
   - Создание розыгрыша
   - Оплата участия
   - Автоматическую выплату

#### Mainnet

1. Убедитесь что все работает в testnet
2. Переключите `TON_NETWORK=mainnet`
3. Используйте реальный кошелек с балансом
4. Создайте тестовый розыгрыш с минимальной ставкой

### Шаг 7: Запуск бота

```bash
python app/main.py
```

При успешном запуске вы увидите:
```
TON service initialized for mainnet
TON transaction monitor started
TON wallet balance: XX.XXXX TON
Bot started successfully!
```

## Поток работы TON платежей

### Прием платежей

1. Пользователь нажимает "Участвовать в розыгрыше"
2. Выбирает "Оплатить TON"
3. Получает инструкции:
   - Адрес кошелька бота
   - Сумму (например, 0.5 TON)
   - Уникальный комментарий: `raffle_{raffle_id}_user_{user_id}`
4. Отправляет TON из своего кошелька с комментарием
5. TON monitor обнаруживает транзакцию (в течение 15 сек)
6. Автоматически регистрирует участие
7. При достижении минимума участников - запускает розыгрыш

### Выплата призов

1. Random.org определяет победителя
2. Система проверяет наличие TON кошелька у победителя
3. Автоматически отправляет приз на кошелек победителя
4. Создает запись транзакции в БД с хешем
5. Уведомляет победителя с деталями транзакции
6. В случае ошибки - уведомляет админа для ручной выплаты

## Экономическая модель

| Параметр | Значение |
|----------|----------|
| Минимальная ставка | 0.5 TON (~$2.75-3.5) |
| Комиссия бота | 12% |
| Комиссия сети | ~0.01 TON (~$0.05) |
| Приз победителю | 88% минус комиссия сети |
| Время выплаты | 5-30 секунд |

**Пример расчета (10 участников, 0.5 TON):**
- Сбор: 5 TON
- Комиссия бота (12%): 0.6 TON
- Комиссия сети: 0.01 TON
- Приз: 4.39 TON

## Безопасность

### Хранение мнемоника

⚠️ **КРИТИЧЕСКИ ВАЖНО:**
- Мнемоник кошелька хранится в .env файле
- НЕ коммитьте .env в git
- Используйте сильные права доступа: `chmod 600 .env`
- Рассмотрите использование секретов (Vault, AWS Secrets Manager)
- В production используйте переменные окружения вместо файла

### Резервы

- Поддерживайте минимум 10-20 TON на кошельке
- Мониторьте баланс (бот уведомляет при низком балансе)
- Настройте алерты при балансе < 10 TON

### Верификация

- Все транзакции записываются с хешем
- Можно проверить в блокчейн эксплорере: https://tonscan.org
- Random.org сигнатуры сохраняются для проверки честности

## Откат изменений

Если нужно вернуться к старой системе:

```bash
# Откат миграции БД
alembic downgrade -1

# В .env установить
TON_ONLY=false
STARS_ONLY=true  # или false для RUB

# Перезапустить бота
python app/main.py
```

**Примечание:** Данные пользователей (balance_stars, balance_rub) сохраняются.

## Мониторинг и логи

### Важные логи

```bash
# Проверка логов
tail -f logs/bot_$(date +%Y-%m-%d).log | grep TON

# Мониторинг транзакций
tail -f logs/bot_$(date +%Y-%m-%d).log | grep "Incoming TON transaction"

# Проверка выплат
tail -f logs/bot_$(date +%Y-%m-%d).log | grep "TON payout"
```

### Метрики для мониторинга

- Баланс кошелька (должен быть > TON_RESERVE_MIN)
- Время обработки транзакций (среднее ~15 сек)
- Успешность выплат (должна быть 100%)
- Ошибки TON сервиса

## FAQ

### Почему TON вместо Stars/RUB?

1. **Автоматизация:** Никакого ручного участия админа
2. **Скорость:** Выплаты за секунды вместо часов/дней
3. **Экономия:** Комиссия 12% vs 20% (Stars) или 15% + YooKassa (RUB)
4. **Прозрачность:** Все транзакции в публичном блокчейне
5. **Масштабируемость:** Нет лимитов платежных систем

### Как пользователи получают TON?

- Через @wallet бот в Telegram
- Tonkeeper приложение
- Другие TON кошельки
- Можно купить за фиат через встроенный обмен

### Что если у победителя нет TON кошелька?

Бот уведомит победителя и попросит указать адрес через команду /balance. После указания адреса можно будет выплатить приз вручную или автоматически.

### Безопасно ли хранить мнемоник в .env?

Это компромисс между безопасностью и удобством. Для production рекомендуется:
- Использовать системы управления секретами (Vault, AWS Secrets Manager)
- Ограничить доступ к серверу
- Использовать отдельный кошелек только для бота
- Минимизировать баланс (держать только резерв)

### Можно ли использовать TON и Stars одновременно?

Да, установите `TON_ONLY=false` и система будет поддерживать все три валюты. Но рекомендуется использовать только TON для лучшего UX.

## Контакты и поддержка

- Документация TON: https://docs.ton.org
- TON Center API: https://toncenter.com
- pytoniq библиотека: https://github.com/yungwine/pytoniq
- Tonkeeper: https://tonkeeper.com

---

**Версия:** 1.0
**Дата:** 2025-11-16
**Автор:** Claude AI Assistant
